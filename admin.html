<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶€ë™ì‚° ì •ë³´ ë“±ë¡ (ê´€ë¦¬ì)</title>
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #f8f9fa;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            border-bottom: 2px solid #ff9f1c;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            background-color: #ff9f1c;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        button:hover {
            background-color: #e88d15;
        }

        .row {
            display: flex;
            gap: 10px;
        }

        .col {
            flex: 1;
        }

        #map {
            width: 100%;
            height: 300px;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: none;
        }

        .msg {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
            display: none;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
    <!-- ì¹´ì¹´ì˜¤ ì§€ë„ SDK (https ëª…ì‹œ) -->
    <script type="text/javascript"
        src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=963be8495a63901416fb1354f738c826&libraries=services"></script>
    <!-- ë‹¤ìŒ ì£¼ì†Œ ê²€ìƒ‰ SDK (https ëª…ì‹œ) -->
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <!-- Supabase SDK & Auth -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth.js"></script>
</head>

<body>


    <div
        style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ff9f1c; padding-bottom: 10px; margin-bottom: 20px;">
        <h1 style="border:none; padding:0; margin:0;">ğŸ¢ ë¶€ë™ì‚° ë§¤ë¬¼/ì¤‘ê°œì‚¬ ë“±ë¡</h1>
        <div style="text-align: right;">
            <a href="index.html" style="text-decoration:none; margin-right:10px; font-size:14px; color:#333;">ğŸ  í™ˆìœ¼ë¡œ</a>
            <span id="userEmail" style="font-size: 14px; color: #666; margin-right: 10px;"></span>
            <button onclick="logout()"
                style="padding: 5px 10px; font-size: 12px; background-color: #666; color:white; border:none; border-radius:4px; cursor:pointer;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>
    <div id="message" class="msg"></div>

    <form id="estateForm">
        <div class="row">
            <div class="col form-group">
                <label>íšŒì‚¬ëª… (í•„ìˆ˜)</label>
                <input type="text" id="company_name" required placeholder="(ì£¼)ë¹Œë“œì˜¨ ë¶€ë™ì‚°ì¤‘ê°œë²•ì¸">
            </div>
            <div class="col form-group">
                <label>ëŒ€í‘œìëª… (í•„ìˆ˜)</label>
                <input type="text" id="ceo_name" required placeholder="í™ê¸¸ë™">
            </div>
        </div>

        <div class="row">
            <div class="col form-group">
                <label>ë“±ë¡ë²ˆí˜¸</label>
                <input type="text" id="registration_number" placeholder="11650-2017-00221">
            </div>
            <div class="col form-group">
                <label>ì‚¬ì—…ìë²ˆí˜¸</label>
                <input type="text" id="business_number" placeholder="123-45-67890">
            </div>
        </div>

        <div class="form-group">
            <label>ì£¼ì†Œ ê²€ìƒ‰ (í•„ìˆ˜)</label>
            <div style="display:flex; gap:10px;">
                <input type="text" id="address" required placeholder="ì£¼ì†Œ ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”" readonly>
                <button type="button" onclick="execDaumPostcode()" style="white-space:nowrap;">ğŸ” ì£¼ì†Œ ì°¾ê¸°</button>
            </div>
            <input type="text" id="address_detail" placeholder="ìƒì„¸ì£¼ì†Œ (ì˜ˆ: 101ë™ 101í˜¸)" style="margin-top:5px;">
            <div id="map"></div> <!-- ì§€ë„ ë¯¸ë¦¬ë³´ê¸° -->
        </div>

        <!-- ìˆ¨ê²¨ì§„ ì¢Œí‘œ í•„ë“œ -->
        <input type="hidden" id="lat">
        <input type="hidden" id="lng">

        <div class="row">
            <div class="col form-group">
                <label>íœ´ëŒ€ì „í™”</label>
                <input type="text" id="phone_mobile" placeholder="010-1234-5678">
            </div>
            <div class="col form-group">
                <label>ì‚¬ë¬´ì‹¤ì „í™”</label>
                <input type="text" id="phone_office" placeholder="02-123-4567">
            </div>
        </div>

        <div class="form-group">
            <label>ì—…ì²´ ìƒì„¸ ì†Œê°œ</label>
            <textarea id="description" rows="4" placeholder="ì—…ì²´ì— ëŒ€í•œ ìƒì„¸í•œ ì†Œê°œë¥¼ ì…ë ¥í•˜ì„¸ìš”."></textarea>
        </div>

        <div class="row">
            <div class="col form-group">
                <label>ê²Œì‹œ ì‹œì‘ì¼</label>
                <input type="date" id="start_date">
            </div>
            <div class="col form-group">
                <label>ê²Œì‹œ ì¢…ë£Œì¼</label>
                <input type="date" id="end_date">
            </div>
        </div>

        <h3>ğŸ”— ë§í¬ ì •ë³´ (ì„ íƒ)</h3>
        <div class="row">
            <div class="col form-group">
                <label>ë¬¸ì˜í•˜ê¸° URL</label>
                <input type="url" id="inquiry_url" placeholder="https://open.kakao.com/...">
            </div>
            <div class="col form-group">
                <label>í™ˆí˜ì´ì§€</label>
                <input type="url" id="website_url" placeholder="http://example.com">
            </div>
        </div>
        <div class="row">
            <div class="col form-group">
                <label>ìœ íŠœë¸Œ</label>
                <input type="url" id="youtube_url">
            </div>
            <div class="col form-group">
                <label>ë¸”ë¡œê·¸</label>
                <input type="url" id="blog_url">
            </div>
        </div>
        <div class="row">
            <div class="col form-group">
                <label>ì¸ìŠ¤íƒ€ê·¸ë¨</label>
                <input type="url" id="instagram_url">
            </div>
            <div class="col form-group">
                <label>í˜ì´ìŠ¤ë¶</label>
                <input type="url" id="facebook_url">
            </div>
            <div class="col form-group">
                <label>ì“°ë ˆë“œ</label>
                <input type="url" id="threads_url">
            </div>
        </div>

        <button type="submit" style="width:100%; margin-top:20px;">âœ… ë¶€ë™ì‚° ë“±ë¡í•˜ê¸°</button>
    </form>

    <script>
        // ë¡œê·¸ì¸ ì²´í¬
        let currentUser = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ í™•ì¸
        checkAuth().then(session => {
            currentUser = session.user;
            document.getElementById('userEmail').innerText = currentUser.email;
        });

        // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ë³¸ ì„¤ì •
        document.getElementById('start_date').valueAsDate = new Date();

        // ë‹¤ìŒ ì£¼ì†Œ ê²€ìƒ‰
        function execDaumPostcode() {
            if (typeof daum === 'undefined') {
                alert("ì£¼ì†Œ ê²€ìƒ‰ ìŠ¤í¬ë¦½íŠ¸ê°€ ë¡œë”©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
                return;
            }

            new daum.Postcode({
                oncomplete: function (data) {
                    var addr = data.roadAddress || data.jibunAddress;
                    document.getElementById("address").value = addr;

                    // ì¹´ì¹´ì˜¤ ì§€ë„ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì²´í¬
                    if (typeof kakao === 'undefined' || !kakao.maps || !kakao.maps.services) {
                        alert("ì§€ë„ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë”©ë˜ì§€ ì•Šì•„ ì¢Œí‘œë¥¼ ìë™ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (API í‚¤/ë„ë©”ì¸ í™•ì¸ í•„ìš”)");
                        return;
                    }

                    // ì£¼ì†Œë¡œ ì¢Œí‘œ ê²€ìƒ‰
                    var geocoder = new kakao.maps.services.Geocoder();
                    geocoder.addressSearch(addr, function (result, status) {
                        if (status === kakao.maps.services.Status.OK) {
                            var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                            document.getElementById('lat').value = result[0].y;
                            document.getElementById('lng').value = result[0].x;

                            // ì§€ë„ ë³´ì—¬ì£¼ê¸°
                            var mapContainer = document.getElementById('map');
                            mapContainer.style.display = "block";
                            var mapOption = { center: coords, level: 3 };
                            var map = new kakao.maps.Map(mapContainer, mapOption);
                            var marker = new kakao.maps.Marker({ position: coords, map: map });
                        } else {
                            alert("ì¢Œí‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ëŠ” ì£¼ì†Œì…ë‹ˆë‹¤.");
                        }
                    });
                }
            }).open();
        }

        // í¼ ì œì¶œ
        document.getElementById('estateForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const lat = document.getElementById('lat').value;
            const lng = document.getElementById('lng').value;

            if (!lat || !lng) {
                alert('ì£¼ì†Œë¥¼ ê²€ìƒ‰í•´ì„œ ì¢Œí‘œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”!');
                return;
            }

            const formData = {
                company_name: document.getElementById('company_name').value,
                ceo_name: document.getElementById('ceo_name').value,
                registration_number: document.getElementById('registration_number').value,
                business_number: document.getElementById('business_number').value,
                address: document.getElementById('address').value,
                address_detail: document.getElementById('address_detail').value,
                lat: parseFloat(lat),
                lng: parseFloat(lng),
                phone_mobile: document.getElementById('phone_mobile').value,
                phone_office: document.getElementById('phone_office').value,
                description: document.getElementById('description').value,
                start_date: document.getElementById('start_date').value,
                end_date: document.getElementById('end_date').value || null,
                inquiry_url: document.getElementById('inquiry_url').value,
                website_url: document.getElementById('website_url').value,
                youtube_url: document.getElementById('youtube_url').value,
                blog_url: document.getElementById('blog_url').value,
                instagram_url: document.getElementById('instagram_url').value,
                facebook_url: document.getElementById('facebook_url').value,
                threads_url: document.getElementById('threads_url').value,
            };

            // ë¹ˆ ë¬¸ìì—´ì€ nullë¡œ ì²˜ë¦¬
            Object.keys(formData).forEach(key => {
                if (formData[key] === "") formData[key] = null;
            });

            // ì‘ì„±ì ID ì¶”ê°€
            formData.user_id = currentUser.id;

            try {
                const { data, error } = await supabase
                    .from('real_estate')
                    .insert([formData])
                    .select();

                const msgDiv = document.getElementById('message');
                msgDiv.style.display = 'block';

                if (error) throw error;

                msgDiv.className = 'msg success';
                msgDiv.innerText = 'âœ… ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!';
                window.scrollTo(0, 0);

                // í¼ ì´ˆê¸°í™”
                e.target.reset();
                document.getElementById('map').style.display = 'none';
                document.getElementById('start_date').valueAsDate = new Date(); // ë‚ ì§œ ë‹¤ì‹œ ì„¸íŒ…

            } catch (error) {
                const msgDiv = document.getElementById('message');
                msgDiv.className = 'msg error';
                msgDiv.innerText = 'âŒ ì—ëŸ¬ ë°œìƒ: ' + error.message;
                window.scrollTo(0, 0);
            }
        });
    </script>
</body>

</html>